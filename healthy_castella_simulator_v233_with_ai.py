# 健康長崎蛋糕脆餅模擬器 v2.3.3（含AI建議模組）
# 使用 Streamlit 可執行，輸入配方百分比，自動產出營養標示與 AI 配方優化建議

import streamlit as st
import pandas as pd

# === 原料資料庫（每100g營養值，部分簡化版） ===
ingredient_db = {
    "液蛋白": {"熱量": 52, "蛋白質": 10.5, "脂肪": 0.2, "碳水": 0.7, "糖": 0.7, "鈉": 166},
    "液蛋黃": {"熱量": 322, "蛋白質": 15.9, "脂肪": 26.5, "碳水": 3.6, "糖": 0.6, "鈉": 48},
    "大豆蛋白": {"熱量": 400, "蛋白質": 88.0, "脂肪": 3.0, "碳水": 1.0, "糖": 0.5, "鈉": 100},
    "乳清蛋白": {"熱量": 370, "蛋白質": 80.0, "脂肪": 1.0, "碳水": 8.0, "糖": 5.0, "鈉": 200},
    "精製細砂": {"熱量": 387, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 100.0, "糖": 100.0, "鈉": 0},
    "多寡糖漿 HM85": {"熱量": 310, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 77.0, "糖": 68.0, "鈉": 20},
    "自來水": {"熱量": 0, "蛋白質": 0, "脂肪": 0, "碳水": 0, "糖": 0, "鈉": 0},
    "統一麵粉": {"熱量": 360, "蛋白質": 10.0, "脂肪": 1.0, "碳水": 76.0, "糖": 1.5, "鈉": 2},
    "無鋁泡打粉": {"熱量": 100, "蛋白質": 0, "脂肪": 0, "碳水": 25.0, "糖": 0.0, "鈉": 10000},
    "穀物奶粉": {"熱量": 500, "蛋白質": 12.0, "脂肪": 25.0, "碳水": 55.0, "糖": 30.0, "鈉": 250},
    "赤藻糖醇": {"熱量": 0, "蛋白質": 0, "脂肪": 0, "碳水": 100.0, "糖": 0.0, "鈉": 0},
    "乳酪粉": {"熱量": 500, "蛋白質": 30.0, "脂肪": 35.0, "碳水": 20.0, "糖": 5.0, "鈉": 800},
    "三合力9285": {"熱量": 200, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 50.0, "糖": 0.0, "鈉": 5000},
    "帕瑪森起士粉": {"熱量": 475, "蛋白質": 42.0, "脂肪": 33.0, "碳水": 5.0, "糖": 1.0, "鈉": 1500},
}

st.title("🧁 健康長崎蛋糕脆餅配方模擬器 v2.3.3")
st.markdown("輸入各原料比例（總和需為100%），系統將自動模擬每份（25g）營養標示並提供 AI 改良建議")

with st.form("配方輸入"):
    default_recipe = {
        "液蛋白": 20.5, "液蛋黃": 6.2, "大豆蛋白": 2.0, "乳清蛋白": 6.5,
        "精製細砂": 15.0, "多寡糖漿 HM85": 2.5, "自來水": 18.8, "統一麵粉": 4.5,
        "無鋁泡打粉": 0.6, "穀物奶粉": 5.7, "赤藻糖醇": 6.0, "乳酪粉": 6.5,
        "三合力9285": 0.2, "帕瑪森起士粉": 5.5
    }
    input_recipe = {}
    total = 0
    for ing, val in default_recipe.items():
        input_recipe[ing] = st.number_input(ing, value=val, step=0.1)
        total += input_recipe[ing]
    submit = st.form_submit_button("執行模擬")

if submit:
    if abs(total - 100) > 0.01:
        st.error(f"配方總和為 {total:.2f}%，請調整至100%")
    else:
        df = pd.DataFrame(columns=["項目", "每25g 含量", "每100g 含量"])
        result_25g = {"熱量": 0, "蛋白質": 0, "脂肪": 0, "碳水": 0, "糖": 0, "鈉": 0}
        for ing, pct in input_recipe.items():
            ref = ingredient_db[ing]
            for key in result_25g:
                result_25g[key] += ref[key] * (pct / 100) * 0.25  # 每25g

        for key in result_25g:
            df.loc[len(df)] = [key, f"{result_25g[key]:.2f}", f"{result_25g[key]*4:.2f}"]

        st.subheader("📊 預估營養標示")
        st.dataframe(df)

        st.subheader("🤖 AI 改良建議")
        suggestions = []
        if result_25g["蛋白質"] < 5.0:
            suggestions.append("➡ 建議提升液蛋白或乳清蛋白比例，以達高蛋白訴求（≥5g）")
        if result_25g["糖"] > 5.0:
            suggestions.append("➡ 可再降低砂糖比例，並提高赤藻糖醇或奶粉補甜香")
        if result_25g["碳水"] > 10.0:
            suggestions.append("➡ 減少麵粉或糖漿使用比例，以控制總碳水 <10g")
        if result_25g["脂肪"] > 3.5:
            suggestions.append("➡ 脂肪略高，檢視是否可減少蛋黃或乳酪粉比例")
        if not suggestions:
            suggestions.append("🎉 配方營養素表現良好，無需重大調整，可進入實驗打樣階段！")

        for s in suggestions:
            st.markdown(f"- {s}")
